# Volcanic::Authenticator

A ruby for gem for Volcanic Authenticator

## Install
```ruby
gem 'volcanic-cache', git: 'git@github.com:volcanic-uk/ruby-cache.git'
gem 'volcanic-authenticator', git: 'git@github.com:volcanic-uk/Authenticator-ruby-gem.git'
```
[volcanic-cache](https://github.com/volcanic-uk/ruby-cache) is required to run this gem. 
    
## Configuration

Add the following to `config/application.rb`:
```ruby
# :+auth_url+: authenticator service url
# :+service_name+: service name
# :+app_name+: service identity name
# :+app_secret+: service identity secret
# :+exp_token+: expire time of token (generated by Token.create(...)). Default expire time is 5 minutes
# :+exp_app_token+: expire time of application (service) token. Default expire time is 1 day
# :+exp_public_key+: expire time public key. Default expire time is 1 day
# :+exp_authorize_token+: expire time of authorize token. Default expire time is 5 minutes
# Note: expire time is in seconds basis 
Volcanic::Authenticator.config.auth_url = 'https://auth.aws.local' 
Volcanic::Authenticator.config.service_name = 'vault'  
Volcanic::Authenticator.config.app_name = 'vault-1' 
Volcanic::Authenticator.config.app_secret = 'vault-secret'  
Volcanic::Authenticator.config.exp_token = 5 * 60 
Volcanic::Authenticator.config.exp_app_token = 24 * 60 * 60 
Volcanic::Authenticator.config.exp_public_key = 24 * 60 * 60 
Volcanic::Authenticator.config.exp_authorize_token = 5 * 60 
```

## Usage

**Token**

attributes `token_key`
1. create token 
    ```ruby
    principal_id = 1 # see how to create Principal
    token = Volcanic::Authenticator::V1::Token.create(name, secret, principal_id)
    token.token_key # => 'eyJhbGciOiJFUzUxMiIsIn...'
    ```

2. validate token signature
    ```ruby
    Volcanic::Authenticator::V1::Token.new(token_key).validate
    # => true/false
    ```

3. validate token by auth service
    ```ruby
    Volcanic::Authenticator::V1::Token.new(token_key).remote_validate
    # => true/false
    ```

4. fetch token claims
    ```ruby
    token_key = 'eyJhbGciOiJFUzUxMiIsIn...'
    token = Volcanic::Authenticator::V1::Token.new(token_key).fetch_claims
    token.token_key = 'eyJhbGciOiJFUzUxMiIsIn...'
    token.kid # => 'a5f53fa2...'
    token.sub # => 'user://sandbox/-1/1/1/2'
    token.iss # => 'volcanic_auth_service_ap2'
    token.dataset_id # => -1
    token.subject_id # => 1
    token.principal_id # => 1
    token.identity_id # => 2
    ```

5. revoke token (logout or blacklist token).
    ```ruby
    Volcanic::Authenticator::V1::Token.new(token_key).revoke!
    # token can no longer be use!
    ```

**Identity**

attributes `id`, `name`, `principal_id`, `secret`, `created_at`, `updated_at`

1. create identity
    ```ruby
    identity = Volcanic::Authenticator::V1::Identity.create(name, principal_id)
    identity.id # => 1
    ...
    
    # with custom secret
    identity = Volcanic::Authenticator::V1::Identity.create(name, principal_id, secret: 'any_secret')
    identity.secret # => 'any_secret'
    ...
    
    # assign privileges and roles.
    identity = Volcanic::Authenticator::V1::Identity.create(name, principal_id, secret: 'any_secret', privileges: [1, 2], roles: [3])
    # see Privileges and Roles for getting the ids.
    ```

2.  update identity
    ```ruby
    identity.name = 'new_name'
    identity.secret = 'new_secret'
    identity.roles = [1]
    identity.privileges = [1, 3]
    identity.save # initiate update to auth service
    # OR
    id = 1 # identity id 
    update_fields = { name: 'new_name', secret: 'new_secret', roles: [1], privileges: [1, 3]} 
    Volcanic::Authenticator::V1::Identity.update(id, update_fields)
    ```

3.  reset secret
    ```ruby
    # Generate new secret
    identity.reset_secret
    # OR
    Volcanic::Authenticator::V1::Identity.reset_secret(1) 
     
    # Use your own custom secret
    identity.reset_secret('new_secret') 
    # OR
    Volcanic::Authenticator::V1::Identity.reset_secret(1, 'new_secret')
    ```

4.  delete identity
    ```ruby
    identity.delete
    # OR
    Volcanic::Authenticator::V1::Identity.delete(1) 
    ```
    
5.  set privileges
    ```ruby
    Identity.set_privileges(1, [1, 2])
    # OR
    Identity.set_privileges(1, 1, 2) 
    ```     
    
6.  set roles
    ```ruby
    Identity.set_roles(1, [1, 2])
    # OR
    Identity.set_roles(1, 1, 2) 
    ```       

##Others

The below objects may have similar method:

1. Service ```:id, :name, :subject_id, :created_at, :updated_at, :active?```
2. Permission ```:id, :name, :description, :subject_id, :service_id, :created_at, :updated_at, :active?```
3. Group ```:id, :name, :description, :subject_id, :created_at, :updated_at, :active?```
4. Privilege ```:id, :scope, :permission_id, :group_id, :subject_id, :created_at, :updated_at, :allow?, :allow!, deny!```
5. Role ```:id, :name, :description, :service_id, :subject_id, :created_at, :updated_at```
6. Principal ```:id, :name, :dataset_id, :created_at, :updated_at, :active?```

Create method
```ruby
# Service
service = Volcanic::Authenticator::V1::Service.create(name)
...

# Permission 
permission = Volcanic::Authenticator::V1::Permission.create(name, service.id, description)
...

# Group
permissions = [1, 2] # optional
group = Volcanic::Authenticator::V1::Group.create(name, description, permissions)
...

# Privilege
scope = 'vrn:sandbox:*:jobs/*' 
privilege = Volcanic::Authenticator::V1::Privilege.create(scope, permission.id, group.id) 
...

# Role
privileges = [1, 3] # optional
role = Volcanic::Authenticator::V1::Role.create(name, service.id, privileges)
...

# Principal
dataset_id = 1 
roles = [1, 2] 
privileges = [1, 3] 
principal = Volcanic::Authenticator::V1::Principal.create(name, dataset_id, roles, privileges)
```

Search (find) method. This apply to all the objects (not just for `service` as example below). 
```ruby
# example for service
service = Service.find(1) # find by id 
service.id
service.name
... 

# then by :page, :page_size, :query, :sort, :order, :pagination

Service.find(page: 1, page_size: 2)
# => [ <Service:1>, <Service:2> ]
# page is the current page taken
# page_size is the size of the page 
# is deafault to page: 1, page_size: 10 
 
Service.find(query: 'vol') 
# => [ <Service:1 @name='volcanic'>, <Service:2 @name='volume'>, ... ]
# query is a character of field name. Typically it search for object that has name match with query.
# in case of Privilege, it search for the scope instead of name 

Service.find(sort: 'id', order: 'desc')  
# => [ <Service:1 @id = 10>, <Service:2 @id=9'>, ... ]    
# sort must be one of [id, name, created_at, updated_at]
# order must be one of [asc, desc]
        
Service.find(pagination: true)
# => { 
#       pagination: { page:1, pageSize:10, rowCount:10, pageCount: 1 }, 
#       data: [...] 
#    }   
# page is current page
# pageSize is the size of the data in a page
# rowCount is the total count of data
# pageCount is the total count of page.
# data is the array of Objects
# Note: by default pagination is set to false     
```

Update object attributes. Example below is the possible attributes that can be updated.
```ruby
# to initiate update, can just run instance method of .save

# Service
service.name = 'new_name'
service.save 

# Permission
permission.name = 'new_name'
permission.description = 'new_description'
permission.save 

# Group
group.name = 'new_name'
group.description = 'new_description' 
group.save

# Privilege
privilege.scope = 'vrn:*:*:jobs/*'
privilege.permission_id = 1
privilege.group_id = 1
privilege.save
privilege.allow! # this will allow privilege
privilege.deny! # this will deny privilege
privilege.allow? # get allow status

# Role
role.name = 'new_name'
role.service_id = 1
role.save

# Principal
principal.name = 'new_name'
principal.dataset_id = 1
principal.save
```

Delete. 

```ruby
# this also applies to others. here is only example of service
service.delete
```

Get first row of the objects
```ruby
# this also applies to others. here is only example of service
service.first # => return service object
```

Get last row of the objects
```ruby
# this also applies to others. here is only example of service
service.last # => return service object
```

Get total row of the objects
```ruby
# this also applies to others. here is only example of service
service.count # => return count number
```